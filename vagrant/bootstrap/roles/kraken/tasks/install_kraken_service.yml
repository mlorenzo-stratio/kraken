---

- name: Create {{ group }} group
  group:
    name: "{{ group }}"
    state: present
    system: yes
  notify: Start {{ service }} service
  when: group is defined

- name: Create {{ user }} user
  user:
    name: "{{ user }}"
    group: "{{ group }}"
    state: present
    system: yes
  notify: Start {{ service }} service
  when: user is defined

- name: Create {{ service }} folders
  file:
    path: "{{ item.value.path }}"
    state: directory
    mode: "{{ item.value.mode }}"
    owner: "{{ user }}"
    group: "{{ group }}"
  with_dict: "{{ service_folders }}"
  notify: Start {{ service }} service
  when: service_folders is defined

- name: Install {{ service }}
  copy:
    src: "{{ item.value.src }}"
    dest: "{{ item.value.dest }}"
    mode: 0755
    owner: "{{ user }}"
    group: "{{ group }}"
  with_dict: "{{ service_binary_files }}"
  notify: Start {{ service }} service
  when: service_binary_files is defined

- name: Create {{ service }} configuration files
  template:
    src: "{{ item.value.src }}"
    dest: "{{ item.value.dest }}"
    mode: 0644
    owner: "{{ user }}"
    group: "{{ group }}"
  with_dict: "{{ service_config_templates }}"
  notify: Start {{ service }} service
  when: service_config_templates is defined

- name: Copy {{ service }} configuration files
  copy:
    src: "{{ item.value.src }}"
    dest: "{{ item.value.dest }}"
    mode: 0644
    owner: "{{ user }}"
    group: "{{ group }}"
  with_dict: "{{ service_config_files }}"
  notify: Start {{ service }} service
  when: service_config_files is defined

- name: Set correct files permissions
  file:
    path: "{{ item.value.path }}"
    mode: "{{ item.value.mode }}"
    state: file
    group: "{{ group }}"
  with_dict: "{{ files_permissions }}"
  notify: Start {{ service }} service
  when: fix_permissions | default(false) | bool

- name: Copy {{ service }} TLS certificates
  template:
    src: "{{ item.value.src }}"
    dest: "{{ item.value.dest }}"
    mode: 0600
    owner: "{{ user }}"
    group: "{{ group }}"
  with_dict: "{{ service_tls_certificates }}"
  notify: Start {{ service }} service
  when: service_tls_certificates is defined

- name: Start {{ service }} service
  systemd:
    daemon_reload: yes
    name: "{{ service }}"
    enabled: yes
    state: started