---
# FROM debian:9

# RUN apt-get update && apt-get install -y curl nginx

# RUN mkdir -p -m 777 /var/log/kraken/kraken-agent
# RUN mkdir -p -m 777 /var/cache/kraken/kraken-agent
# RUN mkdir -p -m 777 /var/run/kraken

# ARG USERNAME="root"
# ARG USERID="0"
# RUN if [ ${USERID} != "0" ]; then useradd --uid ${USERID} ${USERNAME}; fi

# COPY ./docker/setup_nginx.sh /tmp/setup_nginx.sh
# RUN /tmp/setup_nginx.sh ${USERNAME}

# USER ${USERNAME}

# COPY ./agent/agent /usr/bin/kraken-agent
# COPY ./config /etc/kraken/config
# COPY ./nginx/config /etc/kraken/nginx/config
# COPY ./test/tls /etc/kraken/tls

# WORKDIR /etc/kraken



# # Define agent ports.
# AGENT_REGISTRY_PORT=16000
# AGENT_PEER_PORT=16001
# AGENT_SERVER_PORT=16002

# # Hostname for docker for mac.
# HOSTNAME=host.docker.internal

# # Container config.
# AGENT_CONTAINER_NAME=kraken-agent-one

# # Start kraken agent.
# docker run -d \
#     --add-host host.docker.internal:$(docker inspect kraken-herd | jq '.[].NetworkSettings.Networks.bridge.IPAddress' -r) \
#     -p ${AGENT_PEER_PORT}:${AGENT_PEER_PORT} \
#     -p ${AGENT_SERVER_PORT}:${AGENT_SERVER_PORT} \
#     -p ${AGENT_REGISTRY_PORT}:${AGENT_REGISTRY_PORT} \
#     -v $(pwd)/examples/devcluster/config/agent/development.yaml:/etc/kraken/config/agent/development.yaml \
#     --name ${AGENT_CONTAINER_NAME} \
#     kraken-agent:dev \
#     /usr/bin/kraken-agent --config=/etc/kraken/config/agent/development.yaml --peer-ip=${HOSTNAME} --peer-port=${AGENT_PEER_PORT} --agent-server-port=${AGENT_SERVER_PORT} --agent-registry-port=${AGENT_REGISTRY_PORT}

- name: Install EPEL repository
  yum:
    name: epel-release
    state: latest

- name: Install packages
  yum:
    name: ['curl', 'nginx']
    state: latest

- name: Install kraken-agent
  import_tasks: install_kraken_service.yml
  vars:
    service: kraken-agent
    tls_enabled: yes
    user: "{{ kraken_agent_user }}"
    group: "{{ kraken_group }}"
    service_folders: "{{ kraken_agent_folders }}"
    service_binary_files: "{{ binary_files.kraken_agent }}"
    service_config_templates: "{{ config_files.kraken_agent_templates }}"
    service_config_files: "{{ config_files.kraken_agent_files }}"
    service_tls_certificates: "{{ tls_certificates.kraken_agent }}"