---
- hosts: localhost
  tasks:
    - name: Build kraken
      import_role:
        name: kraken
        tasks_from: build-kraken

- hosts: agents, herd
  become: true
  tasks:
    - name: Adding hosts to /etc/hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: '^{{hostvars[item]["ansible_default_ipv4"]["address"]}}\s+'
        line: "{{hostvars[item]['ansible_default_ipv4']['address']}} {{hostvars[item]['ansible_fqdn']}} {{hostvars[item]['ansible_hostname']}} host.docker.internal"
        backup: yes
        state: present
      with_items: "{{groups['herd']}}"

- hosts: localhost
  become: true
  tasks:
    - name: Adding kraken to /etc/hosts file
      lineinfile:
        dest: /etc/hosts
        regexp: '^.*\s+kraken$'
        line: "{{hostvars[item]['ansible_default_ipv4']['address']}} {{hostvars[item]['ansible_fqdn']}} kraken"
        backup: yes
        state: present
      with_items: "{{groups['agents'][0]}}"

- hosts: herd
  become: true
  tasks:
    - name: Import redis tasks from kraken role
      import_role:
        name: kraken
        tasks_from: redis

- hosts: agents
  become: true
  tasks:
    - name: Import agent tasks from kraken role
      import_role:
        name: kraken
        tasks_from: agent

- hosts: herd
  become: true
  tasks:
    - name: Import origin tasks from kraken role
      import_role:
        name: kraken
        tasks_from: origin

- hosts: herd
  become: true
  tasks:
    - name: Import tracker tasks from kraken role
      import_role:
        name: kraken
        tasks_from: tracker


- hosts: herd
  become: true
  tasks:
    - name: Import build-index tasks from kraken role
      import_role:
        name: kraken
        tasks_from: build-index